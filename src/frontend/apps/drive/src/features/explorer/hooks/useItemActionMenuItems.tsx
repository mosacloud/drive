import { Item, ItemType } from "@/features/drivers/types";
import { useTreeContext, MenuItem } from "@gouvfr-lasuite/ui-kit";
import { useModal } from "@gouvfr-lasuite/cunningham-react";
import { t } from "i18next";
import {
  itemToTreeItem,
  useGlobalExplorer,
} from "../components/GlobalExplorerContext";
import settingsSvg from "@/assets/icons/settings.svg";
import starredSvg from "@/assets/icons/starred.svg";
import unstarredSvg from "@/assets/icons/starred-slash.svg";
import { useDownloadItem } from "@/features/items/hooks/useDownloadItem";
import { ExplorerRenameItemModal } from "../components/modals/ExplorerRenameItemModal";
import { ItemShareModal } from "../components/modals/share/ItemShareModal";
import { useDeleteItem } from "./useDeleteItem";
import { ExplorerMoveFolder } from "../components/modals/move/ExplorerMoveFolderModal";
import { getParentIdFromPath, setManualNavigationItemId } from "../utils/utils";
import { useRouter } from "next/router";
import { useEffect, useState } from "react";
import {
  useMutationCreateFavoriteItem,
  useMutationDeleteFavoriteItem,
} from "./useMutations";
import { DefaultRoute } from "@/utils/defaultRoutes";

type UseItemActionMenuItemsOptions = {
  onModalOpenChange?: (isModalOpen: boolean) => void;
};

type UseItemActionMenuItemsReturn = {
  getMenuItems: (
    item: Item,
    options?: { minimal?: boolean; itemId?: string },
  ) => MenuItem[];
  modals: React.ReactNode;
  isModalOpen: boolean;
};

export const useItemActionMenuItems = ({
  onModalOpenChange,
}: UseItemActionMenuItemsOptions = {}): UseItemActionMenuItemsReturn => {
  const router = useRouter();
  const { setRightPanelForcedItem, setRightPanelOpen, ...explorerContext } =
    useGlobalExplorer();
  const { handleDownloadItem } = useDownloadItem();
  const { deleteItems: deleteItem } = useDeleteItem();
  const treeContext = useTreeContext();

  const { mutateAsync: deleteFavoriteItem } = useMutationDeleteFavoriteItem();
  const { mutateAsync: createFavoriteItem } = useMutationCreateFavoriteItem();

  const shareItemModal = useModal();
  const renameModal = useModal();
  const moveModal = useModal();

  const [currentItem, setCurrentItem] = useState<Item | null>(null);

  const isModalOpen =
    renameModal.isOpen || shareItemModal.isOpen || moveModal.isOpen;

  useEffect(() => {
    onModalOpenChange?.(isModalOpen);
  }, [isModalOpen]);

  const handleFavorite = async (effectiveItemId: string, item: Item) => {
    await createFavoriteItem(effectiveItemId, {
      onSuccess: () => {
        const itemTree = itemToTreeItem(item, DefaultRoute.FAVORITES, true);
        treeContext?.treeData.addChild(DefaultRoute.FAVORITES, itemTree);
      },
    });
  };

  const handleUnfavorite = async (effectiveItemId: string) => {
    await deleteFavoriteItem(effectiveItemId);
  };

  const handleDelete = async (effectiveItemId: string, item: Item) => {
    await deleteItem([effectiveItemId]);
    const currentExplorerItem = explorerContext.item;
    if (!currentExplorerItem) return;

    const parentId = getParentIdFromPath(item.path);
    const redirectId: string | undefined = parentId;

    if (redirectId) {
      setManualNavigationItemId(redirectId);
      router.push(`/explorer/items/${redirectId}`);
    } else {
      router.push(`/explorer/items/my-files`);
    }
  };

  const getMenuItems = (
    item: Item,
    options?: { minimal?: boolean; itemId?: string },
  ): MenuItem[] => {
    const minimal = options?.minimal ?? false;
    const effectiveItemId = options?.itemId ?? item.originalId ?? item.id;
    const effectiveItem = { ...item, id: effectiveItemId };

    return [
      {
        icon: <span className="material-icons">info</span>,
        label: t("explorer.item.actions.view_info"),
        isHidden: minimal,
        callback: () => {
          setRightPanelForcedItem(item);
          setRightPanelOpen(true);
        },
      },
      {
        icon: <span className="material-icons">group</span>,
        label: t("explorer.item.actions.share"),
        isHidden: !item.abilities?.accesses_view,
        callback: () => {
          setCurrentItem(effectiveItem);
          shareItemModal.open();
        },
      },
      {
        icon: <span className="material-icons">arrow_forward</span>,
        label: t("explorer.item.actions.move"),
        isHidden: !item.abilities?.move || minimal,
        callback: () => {
          setCurrentItem(effectiveItem);
          moveModal.open();
        },
      },
      {
        icon: <span className="material-icons">download</span>,
        label: t("explorer.item.actions.download"),
        isHidden: item.type === ItemType.FOLDER || minimal,
        callback: () => {
          handleDownloadItem(item);
        },
      },
      { type: "separator" },
      {
        icon: <img src={settingsSvg.src} alt="" />,
        label: t("explorer.item.actions.rename"),
        isHidden: !item.abilities?.update,
        callback: () => {
          setCurrentItem(effectiveItem);
          renameModal.open();
        },
      },
      { type: "separator" },
      {
        icon: (
          <img
            src={item.is_favorite ? unstarredSvg.src : starredSvg.src}
            alt=""
          />
        ),
        label: item.is_favorite
          ? t("explorer.item.actions.unfavorite")
          : t("explorer.item.actions.favorite"),
        isHidden: !item.abilities?.retrieve,
        callback: item.is_favorite
          ? () => handleUnfavorite(effectiveItemId)
          : () => handleFavorite(effectiveItemId, item),
      },
      {
        icon: <span className="material-icons">delete</span>,
        label: t("explorer.item.actions.delete"),
        variant: "danger" as const,
        isHidden: !item.abilities?.destroy || item.main_workspace || minimal,
        callback: () => handleDelete(effectiveItemId, item),
      },
    ];
  };

  const modals = (
    <>
      {currentItem && renameModal.isOpen && (
        <ExplorerRenameItemModal
          {...renameModal}
          item={currentItem}
          key={currentItem.id}
        />
      )}
      {currentItem &&
        currentItem.abilities?.accesses_view &&
        shareItemModal.isOpen && (
          <ItemShareModal
            {...shareItemModal}
            item={currentItem}
            key={currentItem.id}
          />
        )}
      {currentItem && moveModal.isOpen && (
        <ExplorerMoveFolder
          {...moveModal}
          itemsToMove={[currentItem]}
          key={currentItem.id}
          initialFolderId={getParentIdFromPath(currentItem.path)}
        />
      )}
    </>
  );

  return { getMenuItems, modals, isModalOpen };
};
